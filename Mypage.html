<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MyPage</title>
  <link rel="stylesheet" href="CSS/mypage.css" />
  <link rel="stylesheet" href="CSS/Header.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <div id="header-container"></div>
  <div class="content">

    <!-- ✅ 상단 프로필 -->
    <div class="profile-header">
      <img src="assets/news1.png" alt="프로필 이미지" class="profile-img">
      <div class="user-info">
        <div class="user-id">
          <span id="userId">아이디</span>
          <button id="editBtn">✏️</button>
        </div>
        <p>스크랩 기사 수 <span id="scrapCount">0</span></p>
      </div>
    </div>

    <!-- ✅ 메인 구조: 왼쪽 카테고리 / 오른쪽 뉴스 -->
    <div class="main-body" style="display: flex; gap: 40px; margin-top: 40px;">
      <!-- 왼쪽: 카테고리 목록 -->
      <aside class="category-menu" style="flex: 1;">
        <ul id="interestList" class="interest-list" style="list-style: disc; padding-left: 20px;"></ul>
      </aside>

      <!-- 오른쪽: 스크랩 뉴스 -->
      <section class="news-listing" style="flex: 4;">
        <div id="scrapContainer"></div>
      </section>
    </div>

    <!-- ✅ 클릭 수 차트 -->
    <section style="margin: 40px auto; width: 60%;">
      <canvas id="clickChart"></canvas>
    </section>
  </div>

  <!-- 수정 모달 -->
  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>회원정보 수정</h2>
      <form id="editForm">
        <label>관심 카테고리</label>
        <div id="categoryCheckboxes">
          <label><input type="checkbox" value="Politics"> 정치</label>
          <label><input type="checkbox" value="Economy"> 경제</label>
          <label><input type="checkbox" value="Society"> 사회</label>
          <label><input type="checkbox" value="IT"> IT</label>
          <label><input type="checkbox" value="Entertainment"> 연예</label>
        </div>
        <button type="submit">저장</button>
      </form>
    </div>
  </div>

  <script type="module">
    (async () => {
      console.log("✅ JS 시작됨");

      const token = localStorage.getItem("token");

      // ✅ 1. Header 삽입 및 유저 표시
      try {
        const headerRes = await fetch("components/Header.html");
        const headerHTML = await headerRes.text();
        document.getElementById("header-container").innerHTML = headerHTML;

        const loginBtn = document.getElementById("loginBtn");
        const welcomeText = document.getElementById("welcomeText");

        if (loginBtn) {
          loginBtn.onclick = () => {
            console.log("🟥 로그인 버튼 클릭됨");
            location.href = "login.html";
          };
        }

        const userRes = await fetch("http://localhost:8080/api/users/me", {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (userRes.ok) {
          const user = await userRes.json();

          if (loginBtn) loginBtn.style.display = "none";
          if (welcomeText) {
            welcomeText.textContent = `${user.userId}님`;
            welcomeText.style.display = "inline-block";
          }
        } else {
          console.warn("🔒 비로그인 상태입니다.");
          if (loginBtn) loginBtn.style.display = "inline-block";
          if (welcomeText) welcomeText.style.display = "none";
        }

        document.querySelectorAll(".nav-links a[data-category]").forEach(link => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const category = this.getAttribute("data-category");
            localStorage.setItem("selectedCategory", category);
            location.href = "Home.html";
          });
        });

      } catch (err) {
        console.error("❌ Header 삽입 또는 사용자 정보 로딩 중 오류:", err);
      }

      // ✅ 2. 마이페이지 데이터 로딩
      if (!token) {
        alert("로그인이 필요합니다.");
        window.location.href = "login.html";
        return;
      }

      const userIdElem = document.getElementById("userId");
      const scrapCountElem = document.getElementById("scrapCount");
      const interestList = document.getElementById("interestList");
      const scrapContainer = document.getElementById("scrapContainer");

      try {
        const res = await fetch("http://localhost:8080/api/scrap/mypage", {
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await res.json();
        const { userId, scrapCount, interestCategories } = data;

        userIdElem.textContent = userId;
        scrapCountElem.textContent = scrapCount || 0;

        interestList.innerHTML = "";
        interestCategories.forEach(cat => {
          const li = document.createElement("li");
          li.textContent = cat;
          interestList.appendChild(li);
        });

        const groupedRes = await fetch("http://localhost:8080/api/scrap/mypage/grouped", {
          headers: { Authorization: `Bearer ${token}` }
        });

        const groupedData = await groupedRes.json();
        scrapContainer.innerHTML = "";

        groupedData.forEach(group => {
          const section = document.createElement("div");
          section.className = "scrap-category";

          const title = document.createElement("h3");
          title.textContent = group.category;
          section.appendChild(title);

          group.scraps.forEach(news => {
            const article = document.createElement("div");
            article.className = "news-card";
            article.innerHTML = `
              <a href="CardDetail.html" class="news-link" data-news-id="${news.newsId}">
                <img src="${news.imageUrl || 'assets/news1.png'}" alt="뉴스 이미지" />
                <div class="news-title">${news.title}</div>
              </a>
            `;
            section.appendChild(article);
          });

          scrapContainer.appendChild(section);
        });

        const clickRes = await fetch("http://localhost:8080/api/news/click-count/user", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const clickData = await clickRes.json();

        const categoryMap = {
          Politics: "정치",
          Economy: "경제",
          Society: "사회",
          ITScience: "IT/과학",
          LifestyleCulture: "생활/문화",
          Entertainment: "연예",
          HOT_TOPIC: "핫이슈",
        };

        const labels = Object.keys(clickData).map(k => categoryMap[k] || k);
        const counts = Object.values(clickData);

        new Chart(document.getElementById("clickChart"), {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: counts,
              backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#9CCC65', '#FFA726', '#BA68C8'],
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: {
                display: true,
                text: '카테고리별 클릭 수 통계',
                font: { size: 20 }
              },
              datalabels: {
                formatter: (value, ctx) => {
                  const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  return `${((value / total) * 100).toFixed(1)}%`;
                },
                color: '#333',
                font: { weight: 'bold' }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

      } catch (err) {
        console.error("❌ 마이페이지 데이터 로딩 실패:", err);
      }

      // ✅ 카드 클릭 → 상세페이지 이동
      document.getElementById("scrapContainer").addEventListener("click", (e) => {
        const link = e.target.closest(".news-link");
        if (link) {
          const newsId = link.dataset.newsId;
          localStorage.setItem("selectedNewsId", newsId);
          console.log("📰 클릭한 뉴스 ID:", newsId);
        }
      });
    })();
  </script>
</body>
</html>
