<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MyPage</title>
  <link rel="stylesheet" href="CSS/mypage.css" />
  <link rel="stylesheet" href="CSS/Header.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

</head>
<body>
  <div class="content">
    <div id="header-container"></div>

    <aside class="profile-section">
      <img src="assets/news1.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-img">
      <div class="user-info">
        <div class="user-id">
          <span id="userId">ì•„ì´ë””</span>
          <button id="editBtn">âœï¸</button>
        </div>
        <p>ìŠ¤í¬ë© ê¸°ì‚¬ ìˆ˜ <span id="scrapCount">0</span></p>
      </div>
      <ul id="interestList" class="interest-list"></ul>
    </aside>

    <section class="scrap-section">
      <div id="scrapContainer"></div>
    </section>

    <!-- ğŸ‘‡ í´ë¦­ ìˆ˜ í†µê³„ ì°¨íŠ¸ë¥¼ ìœ„í•œ ìº”ë²„ìŠ¤ -->
    <section style="margin: 40px auto; width: 60%;">
      <canvas id="clickChart"></canvas>
    </section>
  </div>

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>íšŒì›ì •ë³´ ìˆ˜ì •</h2>
      <form id="editForm">

        <label>ê´€ì‹¬ ì¹´í…Œê³ ë¦¬</label>
        <div id="categoryCheckboxes">
          <label><input type="checkbox" value="Politics"> ì •ì¹˜</label>
          <label><input type="checkbox" value="Economy"> ê²½ì œ</label>
          <label><input type="checkbox" value="Society"> ì‚¬íšŒ</label>
          <label><input type="checkbox" value="IT"> IT</label>
          <label><input type="checkbox" value="Entertainment"> ì—°ì˜ˆ</label>
        </div>

        <button type="submit">ì €ì¥</button>
      </form>
    </div>
  </div>

  <script>
    // âœ… í—¤ë” ë¡œë”© í›„ ë¡œê·¸ì¸ ìƒíƒœ ë° ì¹´í…Œê³ ë¦¬ í´ë¦­ ì²˜ë¦¬
    fetch("components/Header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-container").innerHTML = data;

        const loginBtn = document.getElementById("loginBtn");
        const welcomeText = document.getElementById("welcomeText");
        const storedUserId = localStorage.getItem("userId");
        const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";

        if (isLoggedIn && storedUserId) {
          if (loginBtn) loginBtn.style.display = "none";
          if (welcomeText) {
            welcomeText.style.display = "inline-block";
            welcomeText.textContent = `${storedUserId}ë‹˜ ë°˜ê°€ì›Œìš”!`;
            welcomeText.style.fontWeight = "bold";
          }
        } else {
          if (loginBtn) {
            loginBtn.style.display = "inline-block";
            loginBtn.textContent = "Login";
            loginBtn.onclick = () => location.href = "login.html";
          }
          if (welcomeText) welcomeText.style.display = "none";
        }

        // âœ… í—¤ë” ë‚´ ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹œ Home.htmlë¡œ ì´ë™
        document.querySelectorAll(".nav-links a[data-category]").forEach(link => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const category = this.getAttribute("data-category");
            localStorage.setItem("selectedCategory", category);
            location.href = "Home.html";
          });
        });
      });

    window.addEventListener("DOMContentLoaded", async () => {
      const userIdElem = document.getElementById("userId");
      const scrapCountElem = document.getElementById("scrapCount");
      const interestList = document.getElementById("interestList");
      const scrapContainer = document.getElementById("scrapContainer");
      const token = localStorage.getItem("token");

      if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "login.html";
        return;
      }

      try {
        // ğŸ“Œ ìŠ¤í¬ë© ê´€ë ¨ ë°ì´í„° ë¡œë”©
        const res = await fetch("http://localhost:8080/api/scrap/mypage", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();

        const { userId, scrapCount, interestCategories } = data;
        localStorage.setItem("userId", userId);
        localStorage.setItem("isLoggedIn", "true");

        userIdElem.textContent = userId;
        scrapCountElem.textContent = scrapCount || 0;

        interestList.innerHTML = "";
        interestCategories.forEach(cat => {
          const li = document.createElement("li");
          li.textContent = cat;
          interestList.appendChild(li);
        });

        const groupedRes = await fetch("http://localhost:8080/api/scrap/mypage/grouped", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const groupedData = await groupedRes.json();
        scrapContainer.innerHTML = "";

        groupedData.forEach(group => {
          const section = document.createElement("div");
          section.className = "scrap-category";

          const title = document.createElement("h3");
          title.textContent = group.category;
          section.appendChild(title);

          group.scraps.forEach(news => {
            const article = document.createElement("div");
            article.className = "news-card";
            article.innerHTML = `
              <a href="CardDetail.html" class="news-link" data-news-id="${news.newsId}">
                <img src="${news.imageUrl || 'assets/news1.png'}" alt="ë‰´ìŠ¤ ì´ë¯¸ì§€" />
                <div class="news-title">${news.title}</div>
              </a>
            `;
            section.appendChild(article);
          });

          scrapContainer.appendChild(section);
        });

        // ğŸ“Š í´ë¦­ ìˆ˜ í†µê³„ ê·¸ë˜í”„ ìƒì„±
        const clickRes = await fetch("http://localhost:8080/api/news/click-count/user", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const clickData = await clickRes.json();
        const labels = Object.keys(clickData);
        const counts = Object.values(clickData);

        new Chart(document.getElementById("clickChart"), {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: counts,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#9CCC65', '#FFA726', '#BA68C8'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            title: {
              display: true,
              text: 'ì¹´í…Œê³ ë¦¬ë³„ í´ë¦­ ìˆ˜ í†µê³„'
            },
            datalabels: {
              formatter: (value, context) => {
                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percent = ((value / total) * 100).toFixed(1);
                return `${percent}%`;
              },
              color: '#333',
              font: {
                weight: 'bold'
              }
            }
          }
        },
        plugins: [ChartDataLabels] // í”ŒëŸ¬ê·¸ì¸ í™œì„±í™”
      });


      } catch (err) {
        console.error("ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      }
    });

    document.addEventListener("click", async (e) => {
      const token = localStorage.getItem("token");
      const modal = document.getElementById("editModal");

      if (e.target.id === "editBtn") {
        modal.classList.remove("hidden");
        try {
          const res = await fetch("http://localhost:8080/api/users/me", {
            headers: { "Authorization": `Bearer ${token}` }
          });
          const user = await res.json();
          const checks = document.querySelectorAll("#categoryCheckboxes input");
          checks.forEach(chk => chk.checked = user.interestCategories.includes(chk.value));
        } catch (err) {
          console.error("íšŒì›ì •ë³´ ë¡œë”© ì‹¤íŒ¨", err);
        }
      }

      if (e.target.classList.contains("close-btn")) {
        modal.classList.add("hidden");
      }
    });

    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = localStorage.getItem("token");

      const updated = {
        style: document.getElementById("style")?.value || "",
        interestCategories: Array.from(document.querySelectorAll("#categoryCheckboxes input:checked")).map(c => c.value)
      };

      try {
        const res = await fetch("http://localhost:8080/api/users/me", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(updated)
        });

        if (res.ok) {
          alert("íšŒì›ì •ë³´ ìˆ˜ì • ì™„ë£Œ");
          document.getElementById("editModal").classList.add("hidden");
          location.reload();
        } else {
          alert("ìˆ˜ì • ì‹¤íŒ¨");
        }
      } catch (err) {
        console.error("ìˆ˜ì • ì˜¤ë¥˜", err);
      }
    });

    // ë§ˆì´í˜ì´ì§€ ì¹´ë“œ í´ë¦­ ì‹œ ë‰´ìŠ¤ ID ì €ì¥
    document.getElementById("scrapContainer").addEventListener("click", (e) => {
      const link = e.target.closest(".news-link");
      if (link) {
        const newsId = link.dataset.newsId;
        localStorage.setItem("selectedNewsId", newsId);
        console.log("í´ë¦­í•œ ë‰´ìŠ¤ ID ì €ì¥ë¨:", newsId);
      }
    });
  </script>
</body>
</html>
