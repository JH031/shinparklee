<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MyPage</title>
  <link rel="stylesheet" href="CSS/mypage.css" />
  <link rel="stylesheet" href="CSS/Header.css" />
  <link rel="stylesheet" href="CSS/Footer.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <div id="header-container"></div>
  <div class="content">

    <!-- âœ… ìƒë‹¨ ì „ì²´ êµ¬ì¡°: í”„ë¡œí•„ ì´ë¯¸ì§€ + ì˜¤ë¥¸ìª½ ì •ë³´ + ì•„ë˜ ë‰´ìŠ¤ ì „ì²´ í¬í•¨ -->
    <div class="top-section" style="display: flex; gap: 25px; align-items: flex-start; margin-top: 40px;">
      <!-- âœ… ì™¼ìª½: í”„ë¡œí•„ ì´ë¯¸ì§€ -->
      <div style="flex-shrink: 0;">
        <img src="assets/mypageuser.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-img" style="width: 100px; height: 100px; border-radius: 50%;" />
      </div>

      <!-- âœ… ì˜¤ë¥¸ìª½: ì•„ì´ë”” + ìŠ¤í¬ë© ìˆ˜ + ì¹´í…Œê³ ë¦¬ + ë¦¬ìŠ¤íŠ¸ -->
      <div style="flex: 1;">
        <div class="user-id" style="display: flex; align-items: center; gap: 10px; font-size: 20px; font-weight: bold;">
          <span id="userId">ì•„ì´ë””</span>
        </div>
        <p>ìŠ¤í¬ë©í•œ ê¸°ì‚¬ ìˆ˜ <span id="scrapCount">0</span></p>
        <p>
          <strong>ê´€ì‹¬ ì¹´í…Œê³ ë¦¬ 
            <button id="editBtn" style="cursor: pointer; background: none; border: none; padding: 0; margin-left: 5px; vertical-align: middle;">
              <img src="assets/edit.png" alt="ìˆ˜ì •" style="width: 18px; height: 18px; vertical-align: middle;" />
            </button>
          </strong>
        </p>
        <ul id="interestList" class="interest-list" style="list-style: disc; padding-left: 20px;"></ul>
      </div>
      
    </div>

    <!-- âœ… ë‰´ìŠ¤ ì „ì²´ ì˜ì—­: ì™¼ìª½ ì¹´í…Œê³ ë¦¬ + ì˜¤ë¥¸ìª½ ìŠ¤í¬ë© ë‰´ìŠ¤ -->
    <div class="main-body" style="display: flex; margin-top: 10px; gap: 40px;">
      <!-- âœ… ì™¼ìª½: ìŠ¤í¬ë©ëœ ë‰´ìŠ¤ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ -->
      <aside class="category-menu" style="flex: 1;">
        <ul id="scrapCategoryList" class="interest-list" style="list-style: disc; padding-left: 20px;"></ul>
      </aside>

      <!-- âœ… ì˜¤ë¥¸ìª½: ë‰´ìŠ¤ ì¹´ë“œë“¤ -->
      <section class="news-listing" style="flex: 4;">
        <div id="scrapContainer"></div>
      </section>
    </div>


    <!-- âœ… í´ë¦­ ìˆ˜ ì°¨íŠ¸ -->
    <section style="margin: 40px auto; width: 60%;">
      <canvas id="clickChart"></canvas>
    </section>
    
  </div>
  <div id="footer-container"></div>
  

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>íšŒì›ì •ë³´ ìˆ˜ì •</h2>
      <form id="editForm">
        <label>ê´€ì‹¬ ì¹´í…Œê³ ë¦¬</label>
        <div id="categoryCheckboxes">
          <label><input type="checkbox" value="Politics"> ì •ì¹˜</label>
          <label><input type="checkbox" value="Economy"> ê²½ì œ</label>
          <label><input type="checkbox" value="Society"> ì‚¬íšŒ</label>
          <label><input type="checkbox" value="ITScience"> IT</label>
          <label><input type="checkbox" value="Entertainment"> ì—”í„°í…Œì¸ë¨¼íŠ¸</label>
        </div>
        <button type="submit">ì €ì¥</button>
      </form>
    </div>
  </div>

  <script type="module">
    (async () => {
      console.log("âœ… JS ì‹œì‘ë¨");
      const token = localStorage.getItem("token");

      // âœ… 1. Header ì‚½ì…
      try {
        const headerRes = await fetch("components/Header.html");
        const headerHTML = await headerRes.text();
        document.getElementById("header-container").innerHTML = headerHTML;

        // âœ… Footer ì‚½ì…
        const footerRes = await fetch("components/Footer.html");
        const footerHTML = await footerRes.text();
        document.getElementById("footer-container").innerHTML = footerHTML;

        const loginBtn = document.getElementById("loginBtn");
        const welcomeText = document.getElementById("welcomeText");

        if (loginBtn) {
          loginBtn.onclick = () => {
            location.href = "login.html";
          };
        }

        const userRes = await fetch("http://localhost:8080/api/users/me", {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (userRes.ok) {
          const user = await userRes.json();
          if (loginBtn) loginBtn.style.display = "none";
          if (welcomeText) {
            welcomeText.textContent = `${user.userId}ë‹˜`;
            welcomeText.style.display = "inline-block";
          }
        } else {
          if (loginBtn) loginBtn.style.display = "inline-block";
          if (welcomeText) welcomeText.style.display = "none";
        }

        document.querySelectorAll(".nav-links a[data-category]").forEach(link => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const category = this.getAttribute("data-category");
            localStorage.setItem("selectedCategory", category);
            location.href = "Home.html";
          });
        });

      } catch (err) {
        console.error("âŒ Header/Footer ì‚½ì… ì¤‘ ì˜¤ë¥˜:", err);
      }

      // âœ… 2. ë§ˆì´í˜ì´ì§€ ë°ì´í„° ë¡œë”©
      if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "login.html";
        return;
      }

      const userIdElem = document.getElementById("userId");
      const scrapCountElem = document.getElementById("scrapCount");
      const interestList = document.getElementById("interestList");
      const scrapContainer = document.getElementById("scrapContainer");

      try {
        const res = await fetch("http://localhost:8080/api/scrap/mypage", {
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = await res.json();
        const { userId, scrapCount, interestCategories } = data;

        userIdElem.textContent = userId;
        scrapCountElem.textContent = scrapCount || 0;

        interestList.innerHTML = "";
        interestCategories.forEach(cat => {
          const li = document.createElement("li");
          li.textContent = cat;
          interestList.appendChild(li);
        });

        const groupedRes = await fetch("http://localhost:8080/api/scrap/mypage/grouped", {
          headers: { Authorization: `Bearer ${token}` }
        });

        const groupedData = await groupedRes.json();
        console.log("ğŸ“¦ ì„œë²„ì—ì„œ ë°›ì€ groupedData:", groupedData);
        const scrapCategoryList = document.getElementById("scrapCategoryList");
        scrapCategoryList.innerHTML = ""; // ì´ˆê¸°í™”

        groupedData.forEach(group => {
        // âœ… ì™¼ìª½ ì¹´í…Œê³ ë¦¬ ëª©ë¡ li ìƒì„± + í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ ì´ë™
        const catLi = document.createElement("li");
        catLi.textContent = group.category;
        catLi.style.cursor = "pointer";
        catLi.addEventListener("click", () => {
          const target = document.getElementById(`section-${group.category}`);
          if (target) {
            target.scrollIntoView({ behavior: "smooth" });
          }
        });
        scrapCategoryList.appendChild(catLi);

        // âœ… ì˜¤ë¥¸ìª½ ë‰´ìŠ¤ ì„¹ì…˜ ìƒì„±
        const section = document.createElement("div");
        section.className = "scrap-category";
        section.id = `section-${group.category}`;

        const title = document.createElement("h3");
        title.textContent = group.category;
        section.appendChild(title);

        group.scraps.forEach(news => {
          const article = document.createElement("div");
          article.className = "news-card";
          article.innerHTML = `
            <a href="#" class="news-link" data-news-id="${news.newsId}">
              <img src="${news.imageUrl || 'assets/news1.png'}" alt="ë‰´ìŠ¤ ì´ë¯¸ì§€" />
              <div class="news-title">${news.title}</div>
            </a>
          `;
          section.appendChild(article);
        });

        scrapContainer.appendChild(section);
      });



        // âœ… ì¹´ë“œ í´ë¦­ â†’ ìƒì„¸í˜ì´ì§€ ì´ë™
       document.getElementById("scrapContainer").addEventListener("click", (e) => {
        const link = e.target.closest(".news-link");
        if (link) {
          e.preventDefault();  // <a> íƒœê·¸ì˜ ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨
          const newsId = link.dataset.newsId;

          if (!newsId) {
            console.warn("âŒ data-news-id ì—†ìŒ");
            return;
          }

          console.log("âœ… ì €ì¥í•  newsId:", newsId);  // ğŸ‘‰ ë°˜ë“œì‹œ ì½˜ì†”ì—ì„œ í™•ì¸í•˜ì„¸ìš”

          localStorage.setItem("selectedNewsId", newsId);
          location.href = "CardDetail.html";
        }
      });





        // âœ… í´ë¦­ìˆ˜ ì°¨íŠ¸
        const clickRes = await fetch("http://localhost:8080/api/news/click-count/user", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const clickData = await clickRes.json();

        const categoryMap = {
          Politics: "ì •ì¹˜",
          Economy: "ê²½ì œ",
          Society: "ì‚¬íšŒ",
          ITScience: "IT/ê³¼í•™",
          LifestyleCulture: "ìƒí™œ/ë¬¸í™”",
          Entertainment: "ì—°ì˜ˆ",
          HOT_TOPIC: "í•«ì´ìŠˆ",
        };

        const labels = Object.keys(clickData).map(k => categoryMap[k] || k);
        const counts = Object.values(clickData);

        new Chart(document.getElementById("clickChart"), {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: counts,
              backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#9CCC65', '#FFA726', '#BA68C8'],
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: {
                display: true,
                text: 'ì¹´í…Œê³ ë¦¬ë³„ í´ë¦­ ìˆ˜ í†µê³„',
                font: { size: 20 }
              },
              datalabels: {
                formatter: (value, ctx) => {
                  const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  return `${((value / total) * 100).toFixed(1)}%`;
                },
                color: '#333',
                font: { weight: 'bold' }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

      } catch (err) {
        console.error("âŒ ë§ˆì´í˜ì´ì§€ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
      }
    })();

    // âœ… âœï¸ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
    document.addEventListener("DOMContentLoaded", () => {
      const editBtn = document.getElementById("editBtn");
      const editModal = document.getElementById("editModal");
      const closeBtn = editModal.querySelector(".close-btn");

      if (editBtn && editModal && closeBtn) {
        editBtn.addEventListener("click", async () => {
          editModal.classList.remove("hidden");

          const token = localStorage.getItem("token");
          const checks = document.querySelectorAll("#categoryCheckboxes input");

          try {
            const res = await fetch("http://localhost:8080/api/users/me", {
              headers: { Authorization: `Bearer ${token}` }
            });
            const user = await res.json();

            checks.forEach(input => {
              input.checked = user.interestCategories.includes(input.value);
            });
          } catch (err) {
            console.error("âŒ ê´€ì‹¬ ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
          }
        });

        closeBtn.addEventListener("click", () => {
          editModal.classList.add("hidden");
        });

        window.addEventListener("click", (event) => {
          if (event.target === editModal) {
            editModal.classList.add("hidden");
          }
        });
      }

      document.getElementById("editForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const token = localStorage.getItem("token");

        const updatedCategories = Array.from(document.querySelectorAll("#categoryCheckboxes input:checked"))
          .map(input => input.value);

        try {
          const res = await fetch("http://localhost:8080/api/users/me", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
              interestCategories: updatedCategories
            })
          });

          if (res.ok) {
            document.getElementById("editModal").classList.add("hidden");
            localStorage.setItem("interestCategories", JSON.stringify(updatedCategories));

            // ë§ˆì´í˜ì´ì§€ ê´€ì‹¬ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°±ì‹ 
            const interestList = document.getElementById("interestList");
            interestList.innerHTML = "";
            updatedCategories.forEach(cat => {
              const li = document.createElement("li");
              li.textContent = cat;
              interestList.appendChild(li);
            });
          } else {
            alert("ìˆ˜ì • ì‹¤íŒ¨");
          }
        } catch (err) {
          console.error("âŒ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
        }
      });
    });
  </script>
</body>
</html>
